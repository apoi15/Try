import React, { useState, useRef, useEffect } from 'react';
import { Camera, SwitchCamera, Zap, ZapOff, Download, X, ChevronLeft, ChevronRight, Aperture } from 'lucide-react';

// 滤镜预设配置
const FILTER_PRESETS = [
  { 
    id: 'normal', 
    name: '原片', 
    class: 'brightness-100 contrast-100 saturate-100',
    desc: '真实还原'
  },
  { 
    id: 'classic', 
    name: '经典', 
    class: 'sepia-[0.3] contrast-[1.1] brightness-[1.1] saturate-[0.85]',
    desc: '暖调胶片感'
  },
  { 
    id: 'mono', 
    name: '黑白', 
    class: 'grayscale contrast-[1.2] brightness-[1.05]',
    desc: '高反差黑白'
  },
  { 
    id: 'instant', 
    name: '岁月', 
    class: 'sepia-[0.5] hue-rotate-[-15deg] saturate-[0.6] contrast-[0.9] brightness-[1.1]',
    desc: '褪色老照片'
  },
  { 
    id: 'cool', 
    name: '冷调', 
    class: 'hue-rotate-[15deg] saturate-[0.8] contrast-[1.1] brightness-[1.05]',
    desc: '清冷电影感'
  },
  { 
    id: 'vivid', 
    name: '反转', 
    class: 'saturate-[1.5] contrast-[1.2] brightness-[0.95]',
    desc: '浓郁色彩'
  }
];

export default function App() {
  // 状态管理
  const [stream, setStream] = useState(null);
  const [permissionGranted, setPermissionGranted] = useState(false);
  const [facingMode, setFacingMode] = useState('environment'); // 'user' or 'environment'
  const [currentFilterIdx, setCurrentFilterIdx] = useState(1); // 默认选中经典滤镜
  const [isFlashing, setIsFlashing] = useState(false);
  const [flashOn, setFlashOn] = useState(false);
  const [capturedImage, setCapturedImage] = useState(null);
  const [isDeveloping, setIsDeveloping] = useState(false); // 显影动画状态
  
  // Refs
  const videoRef = useRef(null);
  const canvasRef = useRef(null);

  // 初始化相机
  const startCamera = async () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    try {
      const newStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: facingMode,
          width: { ideal: 1920 },
          height: { ideal: 1920 },
          aspectRatio: 1 // 尝试请求正方形比例，虽然大部分手机会返回4:3或16:9
        },
        audio: false
      });
      
      setStream(newStream);
      setPermissionGranted(true);
      if (videoRef.current) {
        videoRef.current.srcObject = newStream;
      }
    } catch (err) {
      console.error("无法访问相机:", err);
      setPermissionGranted(false);
    }
  };

  // 监听前后摄像头切换
  useEffect(() => {
    startCamera();
    return () => {
      if (stream) stream.getTracks().forEach(track => track.stop());
    };
  }, [facingMode]);

  // 切换摄像头
  const toggleCamera = () => {
    setFacingMode(prev => prev === 'user' ? 'environment' : 'user');
  };

  // 切换滤镜
  const nextFilter = () => {
    setCurrentFilterIdx((prev) => (prev + 1) % FILTER_PRESETS.length);
  };
  
  const prevFilter = () => {
    setCurrentFilterIdx((prev) => (prev - 1 + FILTER_PRESETS.length) % FILTER_PRESETS.length);
  };

  // 拍照逻辑
  const takePhoto = () => {
    if (!videoRef.current || !canvasRef.current) return;

    // 1. 触发闪光灯效果
    setIsFlashing(true);
    setTimeout(() => setIsFlashing(false), 150);

    const video = videoRef.current;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    // 设置画布大小为视频的实际大小
    const size = Math.min(video.videoWidth, video.videoHeight);
    canvas.width = size;
    canvas.height = size;

    // 计算裁剪参数以获得正方形中心图像
    const sx = (video.videoWidth - size) / 2;
    const sy = (video.videoHeight - size) / 2;

    // 绘制视频帧到画布 (注意：这里绘制的是原始无滤镜图像)
    // 如果是前置摄像头，需要水平翻转
    ctx.save();
    if (facingMode === 'user') {
        ctx.translate(size, 0);
        ctx.scale(-1, 1);
    }
    ctx.drawImage(video, sx, sy, size, size, 0, 0, size, size);
    ctx.restore();

    // 获取图片数据
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    setCapturedImage(dataUrl);
    
    // 开始显影动画
    setIsDeveloping(true);
    setTimeout(() => setIsDeveloping(false), 2500); // 2.5秒显影完成
  };

  const retake = () => {
    setCapturedImage(null);
    setIsDeveloping(false);
  };

  // 模拟保存
  const savePhoto = () => {
    // 在实际Web App中，保存图片通常涉及创建一个链接并模拟点击，
    // 或者在移动端长按保存。这里我们模拟一个成功提示。
    const link = document.createElement('a');
    link.download = `polaroid_${Date.now()}.jpg`;
    link.href = capturedImage; // 注意：这里下载的是Raw图片，实际项目中通常需要用Canvas合成边框和滤镜
    document.body.appendChild(link);
    // link.click(); // 许多移动浏览器出于安全原因阻止自动下载
    document.body.removeChild(link);
    
    alert("照片已生成！\n(由于浏览器限制，请长按预览图保存到相册)");
  };

  const currentFilter = FILTER_PRESETS[currentFilterIdx];

  // 如果没有权限
  if (!permissionGranted && stream === null) {
    return (
      <div className="h-screen w-full bg-[#121212] flex flex-col items-center justify-center text-white p-6">
        <Aperture size={64} className="mb-6 text-gray-500 animate-spin-slow" />
        <h1 className="text-2xl font-light mb-2">需要相机权限</h1>
        <p className="text-gray-400 text-center mb-8">请允许访问您的相机以体验复古胶片摄影。</p>
        <button 
          onClick={startCamera}
          className="px-8 py-3 bg-white text-black rounded-full font-medium active:scale-95 transition-transform"
        >
          开启相机
        </button>
      </div>
    );
  }

  // 渲染：预览/结果页面
  if (capturedImage) {
    return (
      <div className="h-screen w-full bg-[#0a0a0a] flex flex-col items-center justify-between py-8 animate-fade-in overflow-hidden">
        {/* 顶部工具栏 */}
        <div className="w-full px-6 flex justify-between items-center z-10">
          <button onClick={retake} className="p-2 rounded-full bg-gray-800/50 text-white backdrop-blur-md">
            <X size={24} />
          </button>
          <span className="text-white/60 font-mono text-sm tracking-widest">PREVIEW</span>
          <button onClick={savePhoto} className="p-2 rounded-full bg-white text-black">
            <Download size={24} />
          </button>
        </div>

        {/* 拍立得照片展示区 */}
        <div className="flex-1 flex items-center justify-center w-full px-4">
          <div className="relative bg-white p-3 pb-12 shadow-[0_10px_40px_rgba(0,0,0,0.5)] rotate-1 transition-transform duration-700 ease-out scale-100" style={{ width: '100%', maxWidth: '360px', aspectRatio: '3.5/4.2' }}>
            {/* 照片区域 */}
            <div className="relative w-full h-0 pb-[100%] bg-gray-100 overflow-hidden border border-gray-200">
              <img 
                src={capturedImage} 
                alt="Captured" 
                className={`absolute inset-0 w-full h-full object-cover transition-all duration-[2500ms] ease-linear ${currentFilter.class} ${isDeveloping ? 'opacity-0 blur-md grayscale' : 'opacity-100 blur-0'}`}
              />
              {/* 显影遮罩层 (模拟逐渐显影效果) */}
              <div className={`absolute inset-0 bg-[#1a1a1a] pointer-events-none transition-opacity duration-[2500ms] ease-in ${isDeveloping ? 'opacity-100' : 'opacity-0'}`}></div>
            </div>
            
            {/* 底部文字区域 */}
            <div className="absolute bottom-3 left-0 w-full text-center">
              <span className={`font-handwriting text-gray-500 text-lg transition-opacity duration-1000 delay-1000 ${isDeveloping ? 'opacity-0' : 'opacity-100'}`}>
                #Polaroid {new Date().toLocaleDateString()}
              </span>
            </div>
            
            {/* 纹理叠加 */}
            <div className="absolute inset-0 bg-noise opacity-[0.03] pointer-events-none mix-blend-overlay"></div>
          </div>
        </div>

        {/* 提示文本 */}
        <div className="text-gray-500 text-sm mb-4 animate-pulse">
          {isDeveloping ? '正在显影...' : '长按图片即可保存'}
        </div>
      </div>
    );
  }

  // 渲染：拍摄页面
  return (
    <div className="h-screen w-full bg-[#000] flex flex-col relative overflow-hidden font-sans text-white select-none">
      {/* 闪光灯层 */}
      <div className={`absolute inset-0 bg-white z-50 pointer-events-none transition-opacity duration-100 ${isFlashing ? 'opacity-100' : 'opacity-0'}`} />

      {/* 顶部控制栏 */}
      <div className="flex justify-between items-center p-6 z-20 bg-gradient-to-b from-black/60 to-transparent">
        <button onClick={() => setFlashOn(!flashOn)} className="p-2 transition-opacity active:opacity-50">
          {flashOn ? <Zap size={24} className="text-yellow-400" /> : <ZapOff size={24} className="text-white/80" />}
        </button>
        <div className="text-xs font-bold tracking-[0.2em] text-white/50 border border-white/20 px-2 py-1 rounded">
          FILM CAM
        </div>
        <button onClick={toggleCamera} className="p-2 transition-opacity active:opacity-50">
          <SwitchCamera size={24} className="text-white/80" />
        </button>
      </div>

      {/* 取景器区域 (模拟 1:1 画幅) */}
      <div className="relative w-full aspect-square bg-[#1a1a1a] overflow-hidden shadow-inner group">
        {/* 视频流 */}
        <video 
          ref={videoRef}
          autoPlay 
          playsInline 
          muted
          className={`w-full h-full object-cover transform transition-all duration-300 ${currentFilter.class} ${facingMode === 'user' ? 'scale-x-[-1]' : ''}`}
        />
        
        {/* 构图辅助线 (九宫格) */}
        <div className="absolute inset-0 pointer-events-none opacity-20">
            <div className="w-full h-full border border-white/30 flex flex-col">
                <div className="flex-1 border-b border-white/30 flex">
                    <div className="flex-1 border-r border-white/30"></div>
                    <div className="flex-1 border-r border-white/30"></div>
                    <div className="flex-1"></div>
                </div>
                <div className="flex-1 border-b border-white/30 flex">
                    <div className="flex-1 border-r border-white/30"></div>
                    <div className="flex-1 border-r border-white/30"></div>
                    <div className="flex-1"></div>
                </div>
                <div className="flex-1 flex">
                    <div className="flex-1 border-r border-white/30"></div>
                    <div className="flex-1 border-r border-white/30"></div>
                    <div className="flex-1"></div>
                </div>
            </div>
        </div>

        {/* 滤镜名称提示 (切换时显示) */}
        <div className="absolute top-4 right-4 bg-black/50 backdrop-blur px-3 py-1 rounded-full text-xs font-medium tracking-wider">
           {currentFilter.name}
        </div>
      </div>

      {/* 底部控制区 */}
      <div className="flex-1 bg-[#050505] flex flex-col justify-end pb-10 relative z-20">
        {/* 滤镜选择轮播 */}
        <div className="flex items-center justify-between px-8 mb-8">
            <button onClick={prevFilter} className="text-white/40 hover:text-white active:scale-90 transition">
                <ChevronLeft size={28} />
            </button>
            
            <div className="flex flex-col items-center justify-center w-40">
                <span className="text-lg font-light tracking-widest mb-1 text-yellow-50/90">{currentFilter.name}</span>
                <span className="text-[10px] text-white/30 uppercase tracking-wider">{currentFilter.desc}</span>
                <div className="flex gap-1 mt-2">
                    {FILTER_PRESETS.map((f, idx) => (
                        <div 
                            key={f.id} 
                            className={`h-1.5 rounded-full transition-all duration-300 ${idx === currentFilterIdx ? 'w-6 bg-white' : 'w-1.5 bg-white/20'}`} 
                        />
                    ))}
                </div>
            </div>

            <button onClick={nextFilter} className="text-white/40 hover:text-white active:scale-90 transition">
                <ChevronRight size={28} />
            </button>
        </div>

        {/* 快门按钮区域 */}
        <div className="flex items-center justify-center relative">
           {/* 快门外环 */}
           <button 
             onClick={takePhoto}
             className="relative group w-20 h-20 rounded-full border-4 border-white/20 flex items-center justify-center transition-all active:scale-95"
           >
             {/* 快门内芯 */}
             <div className="w-16 h-16 bg-white rounded-full shadow-[0_0_20px_rgba(255,255,255,0.3)] group-active:bg-gray-200 transition-colors duration-100" />
           </button>
           
           {/* 装饰性文字 */}
           <div className="absolute right-8 bottom-2">
              <div className="w-10 h-10 bg-gray-800 rounded overflow-hidden border border-gray-700 opacity-50 flex items-center justify-center">
                  {capturedImage ? (
                      <img src={capturedImage} className={`w-full h-full object-cover ${currentFilter.class}`} alt="thumb" />
                  ) : (
                      <div className="w-full h-full bg-gray-900" />
                  )}
              </div>
           </div>
        </div>
      </div>

      {/* 隐藏的 Canvas 用于截图 */}
      <canvas ref={canvasRef} className="hidden" />
      
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cedarville+Cursive&display=swap');
        .font-handwriting {
          font-family: 'Cedarville Cursive', cursive;
        }
        .bg-noise {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
}

