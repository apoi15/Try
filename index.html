<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>复古拍立得 | Polaroid Cam</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cedarville+Cursive&display=swap" rel="stylesheet">

    <style>
        /* 自定义样式与动画 */
        body {
            background-color: #000;
            touch-action: manipulation; /* 防止双击缩放 */
            overscroll-behavior: none; /* 防止橡皮筋效果 */
        }

        .font-handwriting {
            font-family: 'Cedarville Cursive', cursive;
        }

        .bg-noise {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }

        /* 滤镜定义 */
        .filter-normal { filter: brightness(100%) contrast(100%) saturate(100%); }
        .filter-classic { filter: sepia(0.3) contrast(1.1) brightness(1.1) saturate(0.85); }
        .filter-mono { filter: grayscale(100%) contrast(1.2) brightness(1.05); }
        .filter-instant { filter: sepia(0.5) hue-rotate(-15deg) saturate(0.6) contrast(0.9) brightness(1.1); }
        .filter-cool { filter: hue-rotate(15deg) saturate(0.8) contrast(1.1) brightness(1.05); }
        .filter-vivid { filter: saturate(1.5) contrast(1.2) brightness(0.95); }

        /* 显影动画 */
        .photo-developing {
            filter: blur(8px) grayscale(100%) brightness(1.2);
            opacity: 0.8;
            transition: all 2.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .photo-developed {
            filter: blur(0) grayscale(0) brightness(1);
            opacity: 1;
        }

        .mask-developing {
            opacity: 1;
            background-color: #1a1a1a;
            transition: opacity 2.5s ease-in;
        }
        
        .mask-developed {
            opacity: 0;
        }

        .text-developing {
            opacity: 0;
            transition: opacity 1s ease-in 1.5s;
        }
        
        .text-developed {
            opacity: 1;
        }

        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="h-[100dvh] w-full overflow-hidden text-white select-none flex flex-col">

    <!-- 权限提示页面 -->
    <div id="permission-view" class="hidden fixed inset-0 z-50 bg-[#121212] flex flex-col items-center justify-center p-6">
        <i data-lucide="aperture" class="w-16 h-16 mb-6 text-gray-500 animate-spin"></i>
        <h1 class="text-2xl font-light mb-2">需要相机权限</h1>
        <p class="text-gray-400 text-center mb-8">请允许访问您的相机以体验复古胶片摄影。</p>
        <button onclick="initCamera()" class="px-8 py-3 bg-white text-black rounded-full font-medium active:scale-95 transition-transform">
            开启相机
        </button>
    </div>

    <!-- 主相机界面 -->
    <div id="camera-view" class="flex-1 flex flex-col">
        <!-- 顶部状态栏 -->
        <div class="flex items-center justify-between p-4 bg-black/50 backdrop-blur-sm">
            <div class="flex items-center space-x-2">
                <i data-lucide="aperture" class="w-5 h-5"></i>
                <span class="text-sm font-light">复古拍立得</span>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="toggleFlash()" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i id="flash-icon" data-lucide="zap" class="w-5 h-5"></i>
                </button>
                <button onclick="toggleCamera()" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i data-lucide="camera-rotate" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- 取景器区域 -->
        <div class="flex-1 relative bg-black flex items-center justify-center">
            <!-- 相机预览 -->
            <video id="camera-feed" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            
            <!-- 取景框 -->
            <div class="absolute inset-4 border-2 border-white/30 rounded-lg pointer-events-none">
                <div class="absolute top-2 left-2 w-8 h-8 border-l-2 border-t-2 border-white/50"></div>
                <div class="absolute top-2 right-2 w-8 h-8 border-r-2 border-t-2 border-white/50"></div>
                <div class="absolute bottom-2 left-2 w-8 h-8 border-l-2 border-b-2 border-white/50"></div>
                <div class="absolute bottom-2 right-2 w-8 h-8 border-r-2 border-b-2 border-white/50"></div>
            </div>

            <!-- 滤镜预览 -->
            <div id="filter-overlay" class="absolute inset-0 pointer-events-none transition-all duration-300"></div>

            <!-- 对焦指示器 -->
            <div id="focus-indicator" class="hidden absolute w-16 h-16 border-2 border-white/70 rounded-full pointer-events-none">
                <div class="absolute inset-2 border border-white/50 rounded-full"></div>
            </div>
        </div>

        <!-- 底部控制区 -->
        <div class="p-6 bg-black/50 backdrop-blur-sm">
            <!-- 滤镜选择 -->
            <div class="flex justify-center mb-6">
                <div class="flex space-x-2 bg-white/10 rounded-full p-1">
                    <button onclick="setFilter('normal')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-filter="normal">原图</button>
                    <button onclick="setFilter('classic')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-filter="classic">经典</button>
                    <button onclick="setFilter('mono')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-filter="mono">黑白</button>
                    <button onclick="setFilter('instant')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-filter="instant">拍立得</button>
                    <button onclick="setFilter('cool')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-filter="cool">冷调</button>
                    <button onclick="setFilter('vivid')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-filter="vivid">鲜艳</button>
                </div>
            </div>

            <!-- 拍摄按钮 -->
            <div class="flex justify-center mb-4">
                <button onclick="takePhoto()" class="relative group">
                    <div class="w-20 h-20 rounded-full bg-white/10 backdrop-blur-sm border-2 border-white/30 transition-all group-active:scale-95">
                        <div class="absolute inset-2 rounded-full bg-white/20 border border-white/40"></div>
                        <div class="absolute inset-4 rounded-full bg-white/30"></div>
                    </div>
                </button>
            </div>

            <!-- 相册入口 -->
            <div class="flex justify-center">
                <button onclick="openGallery()" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i data-lucide="images" class="w-4 h-4"></i>
                    <span class="text-sm">相册</span>
                    <span id="photo-count" class="text-xs bg-white/20 px-2 py-1 rounded-full">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 照片预览模态框 -->
    <div id="photo-modal" class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-sm">
        <div class="h-full flex flex-col">
            <!-- 顶部工具栏 -->
            <div class="flex items-center justify-between p-4">
                <button onclick="closePhotoModal()" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <button onclick="sharePhoto()" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                        <i data-lucide="share" class="w-5 h-5"></i>
                    </button>
                    <button onclick="downloadPhoto()" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- 照片显示区域 -->
            <div class="flex-1 flex items-center justify-center p-4">
                <div class="relative max-w-sm w-full">
                    <!-- 拍立得相纸效果 -->
                    <div class="bg-white rounded-lg p-4 shadow-2xl">
                        <div class="aspect-[4/3] bg-gray-100 rounded overflow-hidden relative">
                            <img id="photo-display" class="w-full h-full object-cover">
                            <!-- 显影遮罩 -->
                            <div id="developing-mask" class="absolute inset-0 mask-developing flex items-center justify-center">
                                <div class="text-center">
                                    <i data-lucide="aperture" class="w-8 h-8 text-gray-400 mb-2 animate-spin"></i>
                                    <p class="text-gray-500 text-sm developing-text">正在显影...</p>
                                </div>
                            </div>
                        </div>
                        <!-- 底部留白 -->
                        <div class="h-20 mt-4 bg-white flex items-center justify-center">
                            <p id="photo-caption" class="font-handwriting text-gray-800 text-center text-lg"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 相册模态框 -->
    <div id="gallery-modal" class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-sm">
        <div class="h-full flex flex-col">
            <!-- 顶部工具栏 -->
            <div class="flex items-center justify-between p-4">
                <h2 class="text-xl font-light">相册</h2>
                <button onclick="closeGallery()" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- 照片网格 -->
            <div class="flex-1 p-4 overflow-y-auto no-scrollbar">
                <div id="gallery-grid" class="grid grid-cols-3 gap-2">
                    <!-- 照片将通过 JavaScript 动态添加 -->
                </div>
                <div id="empty-gallery" class="text-center py-12">
                    <i data-lucide="camera" class="w-16 h-16 text-gray-600 mb-4"></i>
                    <p class="text-gray-500">还没有照片</p>
                    <p class="text-gray-600 text-sm mt-2">开始拍摄你的第一张复古照片吧！</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 音频元素 -->
    <audio id="shutter-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>

    <script>
        // 全局变量
        let stream = null;
        let currentFilter = 'normal';
        let photos = JSON.parse(localStorage.getItem('polaroid-photos') || '[]');
        let currentPhotoIndex = 0;
        let flashEnabled = false;
        let currentFacingMode = 'environment';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            updatePhotoCount();
            initCamera();
            
            // 设置默认滤镜
            setFilter('normal');
        });

        // 初始化相机
        async function initCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('camera-feed');
                video.srcObject = stream;
                
                // 隐藏权限提示
                document.getElementById('permission-view').classList.add('hidden');
                document.getElementById('camera-view').classList.remove('hidden');
                
            } catch (error) {
                console.error('相机初始化失败:', error);
                document.getElementById('permission-view').classList.remove('hidden');
                document.getElementById('camera-view').classList.add('hidden');
            }
        }

        // 切换闪光灯
        function toggleFlash() {
            flashEnabled = !flashEnabled;
            const icon = document.getElementById('flash-icon');
            if (flashEnabled) {
                icon.classList.add('text-yellow-400');
                icon.classList.remove('text-white');
            } else {
                icon.classList.remove('text-yellow-400');
                icon.classList.add('text-white');
            }
        }

        // 切换相机
        async function toggleCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            await initCamera();
        }

        // 设置滤镜
        function setFilter(filterName) {
            currentFilter = filterName;
            const overlay = document.getElementById('filter-overlay');
            overlay.className = `absolute inset-0 pointer-events-none transition-all duration-300 filter-${filterName}`;
            
            // 更新按钮状态
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filterName) {
                    btn.classList.add('bg-white', 'text-black');
                    btn.classList.remove('text-white', 'hover:bg-white/20');
                } else {
                    btn.classList.remove('bg-white', 'text-black');
                    btn.classList.add('text-white', 'hover:bg-white/20');
                }
            });
        }

        // 拍照
        async function takePhoto() {
            if (!stream) return;

            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置画布尺寸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // 应用滤镜并绘制
            ctx.filter = getFilterCSS(currentFilter);
            ctx.drawImage(video, 0, 0);
            
            // 闪光灯效果
            if (flashEnabled) {
                showFlash();
            }
            
            // 播放快门声
            playShutterSound();
            
            // 获取图片数据
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            
            // 创建照片对象
            const photo = {
                id: Date.now(),
                data: imageData,
                filter: currentFilter,
                caption: generateCaption(),
                timestamp: new Date().toISOString()
            };
            
            // 保存照片
            photos.unshift(photo);
            localStorage.setItem('polaroid-photos', JSON.stringify(photos));
            updatePhotoCount();
            
            // 显示照片预览
            showPhotoPreview(photo);
        }

        // 获取滤镜 CSS
        function getFilterCSS(filterName) {
            const filters = {
                'normal': 'brightness(100%) contrast(100%) saturate(100%)',
                'classic': 'sepia(0.3) contrast(1.1) brightness(1.1) saturate(0.85)',
                'mono': 'grayscale(100%) contrast(1.2) brightness(1.05)',
                'instant': 'sepia(0.5) hue-rotate(-15deg) saturate(0.6) contrast(0.9) brightness(1.1)',
                'cool': 'hue-rotate(15deg) saturate(0.8) contrast(1.1) brightness(1.05)',
                'vivid': 'saturate(1.5) contrast(1.2) brightness(0.95)'
            };
            return filters[filterName] || filters['normal'];
        }

        // 闪光灯效果
        function showFlash() {
            const flash = document.createElement('div');
            flash.className = 'fixed inset-0 bg-white z-50 pointer-events-none';
            flash.style.opacity = '0.8';
            document.body.appendChild(flash);
            
            setTimeout(() => {
                flash.style.transition = 'opacity 0.1s ease-out';
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 100);
            }, 50);
        }

        // 播放快门声
        function playShutterSound() {
            const audio = document.getElementById('shutter-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log('无法播放声音:', e));
        }

        // 生成随机标题
        function generateCaption() {
            const captions = [
                '复古时光', '胶片记忆', '瞬间永恒', '时光印记',
                '怀旧情怀', '经典重现', '美好时光', '珍贵回忆',
                '岁月如歌', '时光倒流', '复古风情', '胶片情怀'
            ];
            return captions[Math.floor(Math.random() * captions.length)];
        }

        // 显示照片预览
        function showPhotoPreview(photo) {
            currentPhotoIndex = 0;
            displayPhoto(photo);
            document.getElementById('photo-modal').classList.remove('hidden');
            
            // 开始显影动画
            setTimeout(() => {
                document.getElementById('developing-mask').classList.add('mask-developed');
                document.getElementById('developing-text').classList.add('text-developed');
            }, 100);
        }

        // 显示照片
        function displayPhoto(photo) {
            document.getElementById('photo-display').src = photo.data;
            document.getElementById('photo-display').className = `w-full h-full object-cover filter-${photo.filter}`;
            document.getElementById('photo-caption').textContent = photo.caption;
            
            // 重置显影状态
            document.getElementById('developing-mask').classList.remove('mask-developed');
            document.getElementById('developing-text').classList.remove('text-developed');
        }

        // 关闭照片预览
        function closePhotoModal() {
            document.getElementById('photo-modal').classList.add('hidden');
        }

        // 分享照片
        function sharePhoto() {
            const photo = photos[currentPhotoIndex];
            if (navigator.share) {
                fetch(photo.data)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'polaroid-photo.jpg', { type: 'image/jpeg' });
                        navigator.share({
                            title: '复古拍立得照片',
                            text: photo.caption,
                            files: [file]
                        });
                    });
            } else {
                alert('您的浏览器不支持分享功能');
            }
        }

        // 下载照片
        function downloadPhoto() {
            const photo = photos[currentPhotoIndex];
            const link = document.createElement('a');
            link.download = `polaroid-${photo.id}.jpg`;
            link.href = photo.data;
            link.click();
        }

        // 打开相册
        function openGallery() {
            renderGallery();
            document.getElementById('gallery-modal').classList.remove('hidden');
        }

        // 关闭相册
        function closeGallery() {
            document.getElementById('gallery-modal').classList.add('hidden');
        }

        // 渲染相册
        function renderGallery() {
            const grid = document.getElementById('gallery-grid');
            const empty = document.getElementById('empty-gallery');
            
            if (photos.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            grid.innerHTML = photos.map((photo, index) => `
                <div class="aspect-square bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" onclick="viewPhoto(${index})">
                    <img src="${photo.data}" class="w-full h-full object-cover filter-${photo.filter}">
                </div>
            `).join('');
        }

        // 查看照片
        function viewPhoto(index) {
            currentPhotoIndex = index;
            displayPhoto(photos[index]);
            closeGallery();
            document.getElementById('photo-modal').classList.remove('hidden');
            
            // 重置显影动画
            document.getElementById('developing-mask').classList.remove('mask-developed');
            document.getElementById('developing-text').classList.remove('text-developed');
            
            setTimeout(() => {
                document.getElementById('developing-mask').classList.add('mask-developed');
                document.getElementById('developing-text').classList.add('text-developed');
            }, 100);
        }

        // 更新照片计数
        function updatePhotoCount() {
            document.getElementById('photo-count').textContent = photos.length;
        }

        // 清理函数
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !document.getElementById('photo-modal').classList.contains('hidden')) {
                e.preventDefault();
                takePhoto();
            }
            if (e.code === 'Escape') {
                if (!document.getElementById('photo-modal').classList.contains('hidden')) {
                    closePhotoModal();
                } else if (!document.getElementById('gallery-modal').classList.contains('hidden')) {
                    closeGallery();
                }
            }
        });
    </script>
</body>
</html>
